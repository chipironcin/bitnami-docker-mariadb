machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
  - docker
  environment:
    IMAGE_NAME: mariadb
    DOCKER_PROJECT: bitnami
    GCLOUD_PROJECT: bitnami-containers

dependencies:
  override:
  - docker info
  - gcloud version
  - docker pull $DOCKER_PROJECT/$IMAGE_NAME:_ || true
  - curl -Y 1000 -y 5 --progress-bar --retry 3 -L https://github.com/docker/compose/releases/download/1.8.1/docker-compose-`uname -s`-`uname -m` > ../bin/docker-compose && chmod +x ../bin/docker-compose

test:
  override:
  - docker build --rm=false -t $DOCKER_PROJECT/$IMAGE_NAME:$CIRCLE_BUILD_NUM .
  - docker-compose build
  - docker-compose pull
  - docker-compose up:
      background: true
  - sleep 30
  - docker-compose stop
  - docker-compose rm -f
